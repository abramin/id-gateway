name: Go CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run vet
        run: go vet ./...

      - name: Run tests
        run: go test ./...

      - name: Run race tests (concurrent packages)
        run: |
          go test -race \
            ./internal/evidence/registry/... \
            ./internal/ratelimit/store/globalthrottle \
            ./internal/ratelimit/store/bucket \
            ./internal/ratelimit/store/quota \
            ./internal/ratelimit/store/authlockout \
            ./internal/ratelimit/store/allowlist \
            ./internal/ratelimit/workers/cleanup \
            ./internal/auth/service \
            ./internal/auth/store/session \
            ./internal/auth/store/revocation \
            ./internal/consent/store \
            ./pkg/platform/audit/publisher \
            ./pkg/platform/audit/store/memory \
            ./pkg/platform/sync

  integration:
    name: Integration Tests (Testcontainers)
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run integration tests
        run: go test -tags=integration -v -timeout 10m ./...
        env:
          TESTCONTAINERS_RYUK_DISABLED: "false"

  e2e:
    name: E2E Tests
    permissions:
      contents: read
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_USER: credo
          POSTGRES_PASSWORD: credo_dev_password
          POSTGRES_DB: credo
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U credo"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build Go application
        run: go build -o bin/credo ./cmd/server/main.go

      - name: Build and start mock citizen-registry
        run: |
          cd mocks/citizen-registry
          go build -o citizen-registry .
          PORT=8082 API_KEY=test-api-key LATENCY_MS=10 ./citizen-registry &
          echo $! > ../../citizen-registry.pid
          cd ../..

      - name: Build and start mock sanctions-registry
        run: |
          cd mocks/sanctions-registry
          go build -o sanctions-registry .
          PORT=8083 API_KEY=test-api-key LATENCY_MS=10 ./sanctions-registry &
          echo $! > ../../sanctions-registry.pid
          cd ../..

      - name: Wait for mock registries to be ready
        run: |
          timeout 10 bash -c 'until curl -f http://localhost:8082/health 2>/dev/null; do sleep 1; done' || true
          timeout 10 bash -c 'until curl -f http://localhost:8083/health 2>/dev/null; do sleep 1; done' || true

      - name: Run database migrations
        run: |
          go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@v4.18.1
          migrate -path migrations -database "postgres://credo:credo_dev_password@localhost:5432/credo?sslmode=disable" up

      - name: Start backend server
        run: |
          ./bin/credo &
          echo $! > server.pid
        env:
          CREDO_ENV: demo
          PORT: 8080
          DATABASE_URL: postgres://credo:credo_dev_password@localhost:5432/credo?sslmode=disable
          REGULATED_MODE: "true"
          CONSENT_GRANT_WINDOW: 1s
          CONSENT_REGRANT_COOLDOWN: 1ns
          CITIZEN_REGISTRY_URL: http://localhost:8082
          CITIZEN_REGISTRY_API_KEY: test-api-key
          SANCTIONS_REGISTRY_URL: http://localhost:8083
          SANCTIONS_REGISTRY_API_KEY: test-api-key

      - name: Wait for server to be ready
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:8080/health 2>/dev/null; do sleep 1; done' || true
          sleep 2

      - name: Run E2E tests
        working-directory: e2e
        run: |
          mkdir -p reports
          GODOG_TAGS="~@simulation && ~@unregulated && ~@pending" go test -v -- -godog.format=cucumber:$(pwd)/reports/cucumber.json
        env:
          BASE_URL: http://localhost:8080
          DISABLE_RATE_LIMITING: "true"

      - name: Generate HTML report
        if: always()
        run: |
          if [ -f e2e/reports/cucumber.json ]; then
            npm install --no-save cucumber-html-reporter
            node e2e/generate-report.js || echo "HTML generation failed but continuing..."
            ls -la e2e/reports/
          else
            echo "cucumber.json not found, skipping HTML generation"
            ls -la e2e/reports/ || echo "reports directory not found"
          fi

      - name: Stop backend server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi

      - name: Stop mock registries
        if: always()
        run: |
          if [ -f citizen-registry.pid ]; then
            kill $(cat citizen-registry.pid) || true
            rm citizen-registry.pid
          fi
          if [ -f sanctions-registry.pid ]; then
            kill $(cat sanctions-registry.pid) || true
            rm sanctions-registry.pid
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            e2e/reports/cucumber.json
            e2e/reports/index.html
          retention-days: 7

  e2e-unregulated:
    name: E2E Tests (Unregulated Mode)
    permissions:
      contents: read
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_USER: credo
          POSTGRES_PASSWORD: credo_dev_password
          POSTGRES_DB: credo
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U credo"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build Go application
        run: go build -o bin/credo ./cmd/server/main.go

      - name: Build and start mock citizen-registry
        run: |
          cd mocks/citizen-registry
          go build -o citizen-registry .
          PORT=8082 API_KEY=test-api-key LATENCY_MS=10 ./citizen-registry &
          echo $! > ../../citizen-registry.pid
          cd ../..

      - name: Build and start mock sanctions-registry
        run: |
          cd mocks/sanctions-registry
          go build -o sanctions-registry .
          PORT=8083 API_KEY=test-api-key LATENCY_MS=10 ./sanctions-registry &
          echo $! > ../../sanctions-registry.pid
          cd ../..

      - name: Wait for mock registries to be ready
        run: |
          timeout 10 bash -c 'until curl -f http://localhost:8082/health 2>/dev/null; do sleep 1; done' || true
          timeout 10 bash -c 'until curl -f http://localhost:8083/health 2>/dev/null; do sleep 1; done' || true

      - name: Run database migrations
        run: |
          go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@v4.18.1
          migrate -path migrations -database "postgres://credo:credo_dev_password@localhost:5432/credo?sslmode=disable" up

      - name: Start backend server (unregulated mode)
        run: |
          ./bin/credo &
          echo $! > server.pid
        env:
          CREDO_ENV: demo
          PORT: 8080
          DATABASE_URL: postgres://credo:credo_dev_password@localhost:5432/credo?sslmode=disable
          REGULATED_MODE: "false"
          CONSENT_GRANT_WINDOW: 1s
          CONSENT_REGRANT_COOLDOWN: 1ns
          CITIZEN_REGISTRY_URL: http://localhost:8082
          CITIZEN_REGISTRY_API_KEY: test-api-key
          SANCTIONS_REGISTRY_URL: http://localhost:8083
          SANCTIONS_REGISTRY_API_KEY: test-api-key

      - name: Wait for server to be ready
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:8080/health 2>/dev/null; do sleep 1; done' || true
          sleep 2

      - name: Run E2E tests (unregulated scenarios)
        working-directory: e2e
        run: |
          mkdir -p reports
          GODOG_TAGS="@unregulated" go test -v -- -godog.format=cucumber:$(pwd)/reports/cucumber.json
        env:
          BASE_URL: http://localhost:8080
          DISABLE_RATE_LIMITING: "true"

      - name: Stop backend server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi

      - name: Stop mock registries
        if: always()
        run: |
          if [ -f citizen-registry.pid ]; then
            kill $(cat citizen-registry.pid) || true
            rm citizen-registry.pid
          fi
          if [ -f sanctions-registry.pid ]; then
            kill $(cat sanctions-registry.pid) || true
            rm sanctions-registry.pid
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-unregulated-test-results
          path: |
            e2e/reports/cucumber.json
          retention-days: 7

  openapi-docs:
    name: Build OpenAPI docs
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Redocly CLI
        run: npm install --no-package-lock --no-save @redocly/cli@1.12.0

      - name: Lint OpenAPI specs
        run: npx @redocly/cli@1.12.0 lint 'docs/openapi/*.yaml'

      - name: Build OpenAPI docs
        run: |
          for file in docs/openapi/*.yaml; do
            basename=$(basename "$file" .yaml)
            npx @redocly/cli@1.12.0 build-docs "$file" -o "docs/openapi/${basename}.html"
          done

      - name: Upload OpenAPI artifacts for PR review
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: openapi-docs
          path: docs/openapi/*.html
          retention-days: 7

      - name: Upload OpenAPI docs artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: openapi-html-docs
          path: docs/openapi/*.html
          retention-days: 1

  e2e-reports:
    name: Prepare E2E reports for Pages
    permissions:
      contents: read
    runs-on: ubuntu-latest
    needs: e2e
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Download E2E report
        uses: actions/download-artifact@v4
        with:
          name: e2e-test-results
          path: e2e-reports/

      - name: Prepare E2E directory structure
        run: |
          mkdir -p pages/e2e
          ls -la e2e-reports/
          if [ -f e2e-reports/index.html ]; then
            cp e2e-reports/index.html pages/e2e/index.html
          else
            echo "HTML report not found, skipping"
          fi
          if [ -f e2e-reports/cucumber.json ]; then
            cp e2e-reports/cucumber.json pages/e2e/cucumber.json
          else
            echo "cucumber.json not found"
          fi

      - name: Upload E2E Pages artifact
        uses: actions/upload-artifact@v4
        with:
          name: e2e-pages
          path: pages/
          retention-days: 1

  combine-pages:
    name: Combine artifacts for Pages
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [openapi-docs, e2e-reports]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy frontend UI first
        run: |
          mkdir -p pages
          cp -r frontend/public/* pages/
          mkdir -p pages/openapi pages/e2e
          ls -la pages/

      - name: Copy Attack Lab static site
        run: |
          mkdir -p pages/lab
          cp -r lab/* pages/lab/
          ls -la pages/lab | head

      - name: Download OpenAPI docs
        uses: actions/download-artifact@v4
        with:
          name: openapi-html-docs
          path: pages/openapi/

      - name: Download E2E reports
        uses: actions/download-artifact@v4
        with:
          name: e2e-pages
          path: pages/

      - name: Verify structure
        run: |
          echo "Pages structure:"
          ls -la pages/
          echo "OpenAPI docs:"
          ls -la pages/openapi/ || echo "No openapi dir"
          echo "E2E reports:"
          ls -la pages/e2e/ || echo "No e2e dir"

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages/

  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: combine-pages
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # deploy-aws:
  #   name: Deploy to AWS Elastic Beanstalk
  #   runs-on: ubuntu-latest
  #   needs: [test, e2e]
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   environment:
  #     name: aws-production
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Set up Go
  #       uses: actions/setup-go@v5
  #       with:
  #         go-version-file: go.mod
  #         cache: true

  #     - name: Build Go application
  #       run: go build -o application ./cmd/server/main.go

  #     - name: Generate deployment timestamp
  #       id: timestamp
  #       run: echo "version=$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

  #     - name: Create deployment package
  #       run: |
  #         mkdir -p deploy
  #         cp application deploy/
  #         cd deploy
  #         zip -r ../deploy-${{ steps.timestamp.outputs.version }}.zip .
  #         cd ..
  #         ls -lh deploy-*.zip

  #     - name: Configure AWS credentials
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws-region: ${{ secrets.AWS_REGION }}

  #     - name: Upload deployment package to S3
  #       run: |
  #         aws s3 cp deploy-${{ steps.timestamp.outputs.version }}.zip \
  #           s3://${{ secrets.EB_BUCKET }}/credo-demo-${{ steps.timestamp.outputs.version }}.zip

  #     - name: Create Elastic Beanstalk application version
  #       run: |
  #         aws elasticbeanstalk create-application-version \
  #           --application-name ${{ secrets.EB_APP_NAME }} \
  #           --version-label v-${{ steps.timestamp.outputs.version }} \
  #           --source-bundle S3Bucket="${{ secrets.EB_BUCKET }}",S3Key="credo-demo-${{ steps.timestamp.outputs.version }}.zip" \
  #           --description "Deploy from GitHub Actions - commit ${GITHUB_SHA::7}"

  #     - name: Deploy to Elastic Beanstalk
  #       run: |
  #         aws elasticbeanstalk update-environment \
  #           --application-name ${{ secrets.EB_APP_NAME }} \
  #           --environment-name ${{ secrets.EB_ENV_NAME }} \
  #           --version-label v-${{ steps.timestamp.outputs.version }}

  #     - name: Wait for deployment to complete
  #       run: |
  #         aws elasticbeanstalk wait environment-updated \
  #           --application-name ${{ secrets.EB_APP_NAME }} \
  #           --environment-name ${{ secrets.EB_ENV_NAME }} \
  #           --max-attempts 30 \
  #           --delay 10

  #     - name: Get deployment URL
  #       id: url
  #       run: |
  #         URL=$(aws elasticbeanstalk describe-environments \
  #           --application-name ${{ secrets.EB_APP_NAME }} \
  #           --environment-names ${{ secrets.EB_ENV_NAME }} \
  #           --query 'Environments[0].CNAME' \
  #           --output text)
  #         echo "url=http://${URL}" >> $GITHUB_OUTPUT
  #         echo "Deployed to: http://${URL}"

  #     - name: Verify deployment
  #       run: |
  #         sleep 10
  #         curl -f ${{ steps.url.outputs.url }}/health || exit 1
  #         echo "âœ… Deployment successful and health check passed"
