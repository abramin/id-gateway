{
  "uid": "credo-overview",
  "title": "Credo Service Overview",
  "tags": ["credo", "observability"],
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 1,
  "refresh": "10s",
  "time": {
    "from": "now-15m",
    "to": "now"
  },
  "annotations": {
    "list": []
  },
  "templating": {
    "list": []
  },
  "panels": [
    {
      "type": "timeseries",
      "title": "Request Rate (RPS)",
      "datasource": "Prometheus",
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 0
      },
      "targets": [
        {
          "expr": "sum(rate(credo_endpoint_latency_seconds_count[5m]))",
          "legendFormat": "rps",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps"
        },
        "overrides": []
      }
    },
    {
      "type": "timeseries",
      "title": "p95 Request Latency (s)",
      "datasource": "Prometheus",
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 0
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(credo_endpoint_latency_seconds_bucket[5m])) by (le))",
          "legendFormat": "p95",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s"
        },
        "overrides": []
      }
    },
    {
      "type": "timeseries",
      "title": "Auth Failures Rate",
      "datasource": "Prometheus",
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 8
      },
      "targets": [
        {
          "expr": "sum(rate(credo_auth_failures_total[5m]))",
          "legendFormat": "failures",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ops"
        },
        "overrides": []
      }
    },
    {
      "type": "stat",
      "title": "Active Sessions",
      "datasource": "Prometheus",
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 8
      },
      "targets": [
        {
          "expr": "credo_active_sessions",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        }
      }
    },
    {
      "type": "row",
      "title": "Auth SLIs",
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 16
      },
      "collapsed": false
    },
    {
      "type": "timeseries",
      "title": "Auth Latency by Tenant (p95)",
      "datasource": "Prometheus",
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 0,
        "y": 17
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(credo_authorize_duration_by_tenant_ms_bucket[5m])) by (le, tenant_id))",
          "legendFormat": "authorize - {{tenant_id}}",
          "refId": "A"
        },
        {
          "expr": "histogram_quantile(0.95, sum(rate(credo_token_exchange_duration_by_tenant_ms_bucket[5m])) by (le, tenant_id))",
          "legendFormat": "exchange - {{tenant_id}}",
          "refId": "B"
        },
        {
          "expr": "histogram_quantile(0.95, sum(rate(credo_token_refresh_duration_by_tenant_ms_bucket[5m])) by (le, tenant_id))",
          "legendFormat": "refresh - {{tenant_id}}",
          "refId": "C"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 200, "color": "yellow" },
              { "value": 500, "color": "red" }
            ]
          }
        },
        "overrides": []
      }
    },
    {
      "type": "timeseries",
      "title": "Auth Errors by Endpoint",
      "datasource": "Prometheus",
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 8,
        "y": 17
      },
      "targets": [
        {
          "expr": "sum(rate(credo_auth_errors_by_endpoint_total[5m])) by (endpoint)",
          "legendFormat": "{{endpoint}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ops"
        },
        "overrides": []
      }
    },
    {
      "type": "stat",
      "title": "TRL Write Failures",
      "datasource": "Prometheus",
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 16,
        "y": 17
      },
      "targets": [
        {
          "expr": "rate(credo_trl_write_failures_total[5m])",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ops",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 0.01, "color": "red" }
            ]
          }
        },
        "overrides": []
      },
      "options": {
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "colorMode": "background"
      }
    },
    {
      "type": "stat",
      "title": "Refresh Token Reuse",
      "datasource": "Prometheus",
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 20,
        "y": 17
      },
      "targets": [
        {
          "expr": "rate(credo_refresh_token_reuse_detections_total[5m])",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ops",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 1, "color": "yellow" },
              { "value": 5, "color": "red" }
            ]
          }
        },
        "overrides": []
      },
      "options": {
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "colorMode": "background"
      }
    },
    {
      "type": "stat",
      "title": "Revocation Lag",
      "datasource": "Prometheus",
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 16,
        "y": 21
      },
      "targets": [
        {
          "expr": "credo_revocation_lag_seconds",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 10, "color": "yellow" },
              { "value": 30, "color": "red" }
            ]
          }
        },
        "overrides": []
      },
      "options": {
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "colorMode": "background"
      }
    },
    {
      "type": "stat",
      "title": "Auth Lockouts",
      "datasource": "Prometheus",
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 20,
        "y": 21
      },
      "targets": [
        {
          "expr": "rate(credo_ratelimit_auth_lockouts_total[5m])",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ops",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 5, "color": "yellow" },
              { "value": 10, "color": "red" }
            ]
          }
        },
        "overrides": []
      },
      "options": {
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "colorMode": "background"
      }
    },
    {
      "type": "row",
      "title": "Audit Durability & Consent",
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 25
      },
      "collapsed": false
    },
    {
      "type": "timeseries",
      "title": "Audit Outbox Queue Depth",
      "datasource": "Prometheus",
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 0,
        "y": 26
      },
      "targets": [
        {
          "expr": "credo_outbox_pending_total",
          "legendFormat": "pending events",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 1000, "color": "yellow" },
              { "value": 10000, "color": "red" }
            ]
          }
        },
        "overrides": []
      }
    },
    {
      "type": "timeseries",
      "title": "Audit Publish Rate",
      "datasource": "Prometheus",
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 8,
        "y": 26
      },
      "targets": [
        {
          "expr": "rate(credo_outbox_published_total[5m])",
          "legendFormat": "published/s",
          "refId": "A"
        },
        {
          "expr": "rate(credo_outbox_publish_failures_total[5m])",
          "legendFormat": "failures/s",
          "refId": "B"
        },
        {
          "expr": "rate(credo_outbox_dropped_events_total[5m])",
          "legendFormat": "dropped/s",
          "refId": "C"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ops"
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "failures/s" },
            "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }]
          },
          {
            "matcher": { "id": "byName", "options": "dropped/s" },
            "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }]
          }
        ]
      }
    },
    {
      "type": "timeseries",
      "title": "Consent Check Pass/Fail by Purpose",
      "datasource": "Prometheus",
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 16,
        "y": 26
      },
      "targets": [
        {
          "expr": "sum(rate(credo_consent_checks_passed_total[5m])) by (purpose)",
          "legendFormat": "passed - {{purpose}}",
          "refId": "A"
        },
        {
          "expr": "sum(rate(credo_consent_checks_failed_by_reason_total[5m])) by (purpose, reason)",
          "legendFormat": "failed - {{purpose}} ({{reason}})",
          "refId": "B"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ops"
        },
        "overrides": []
      }
    }
  ]
}
