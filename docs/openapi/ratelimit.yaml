openapi: 3.0.3
info:
  title: ID Gateway Rate Limiting Admin API
  version: 0.1.0
  description: |
    OpenAPI specification for admin-only rate limiting controls.

    This module exposes endpoints to manage allowlist entries and reset
    rate limit counters. Rate limiting itself is enforced by middleware
    on public and authenticated endpoints.

    **Rate Limit Headers:**
    - `X-RateLimit-Limit`: max requests per window
    - `X-RateLimit-Remaining`: remaining requests in the window
    - `X-RateLimit-Reset`: Unix timestamp when the window resets
    - `Retry-After`: seconds until retry (on 429/503 responses)

    **Rate Limit Errors (non-admin endpoints):**
    - 429 `rate_limit_exceeded`
    - 429 `user_rate_limit_exceeded`
    - 429 `client_rate_limit_exceeded`
    - 503 `service_unavailable`
servers:
  - url: http://localhost:8080
    description: Local development server
paths:
  /admin/rate-limit/allowlist:
    post:
      summary: Add an allowlist entry
      description: |
        Adds an IP address or user ID to the rate limit allowlist.
        Allowlisted identifiers bypass rate limiting until expiry.
      security:
        - adminToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddAllowlistRequest"
            examples:
              ip_allowlist:
                summary: Allowlist IP address
                value:
                  type: ip
                  identifier: 192.168.1.100
                  reason: Monitoring service
                  expires_at: "2025-12-31T00:00:00Z"
              user_allowlist:
                summary: Allowlist user
                value:
                  type: user_id
                  identifier: 550e8400-e29b-41d4-a716-446655440000
                  reason: Executive demo
      responses:
        "200":
          description: Allowlist entry created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AllowlistEntryResponse"
              examples:
                default:
                  value:
                    allowlisted: true
                    identifier: 192.168.1.100
                    expires_at: "2025-12-31T00:00:00Z"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"
    delete:
      summary: Remove an allowlist entry
      description: |
        Removes an IP address or user ID from the allowlist.
      security:
        - adminToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RemoveAllowlistRequest"
            examples:
              ip_remove:
                value:
                  type: ip
                  identifier: 192.168.1.100
      responses:
        "204":
          description: Allowlist entry removed
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"
    get:
      summary: List allowlist entries
      description: Returns all active allowlist entries (non-expired).
      security:
        - adminToken: []
      responses:
        "200":
          description: Allowlist entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AllowlistEntry"
              examples:
                default:
                  value:
                    - id: alw_123
                      type: ip
                      identifier: 192.168.1.100
                      reason: Monitoring service
                      expires_at: "2025-12-31T00:00:00Z"
                      created_at: "2025-01-01T12:00:00Z"
                      created_by: 550e8400-e29b-41d4-a716-446655440000
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"
  /admin/rate-limit/reset:
    post:
      summary: Reset rate limit counters
      description: |
        Clears the rate limit counters for a specific identifier.
        The optional class restricts the reset to a specific endpoint class.
      security:
        - adminToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResetRateLimitRequest"
            examples:
              reset_ip:
                value:
                  type: ip
                  identifier: 192.168.1.100
                  class: auth
              reset_user:
                value:
                  type: user_id
                  identifier: 550e8400-e29b-41d4-a716-446655440000
      responses:
        "204":
          description: Rate limit counters reset
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"
  /admin/rate-limit/quota/{api_key}:
    get:
      summary: Get quota usage for an API key
      description: |
        Returns the current quota usage for a specific API key (PRD-017 FR-5).
        Shows usage, limit, remaining requests, and reset time.
      security:
        - adminToken: []
      parameters:
        - in: path
          name: api_key
          required: true
          schema:
            type: string
            format: uuid
          description: API key identifier
      responses:
        "200":
          description: Quota usage retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuotaUsageResponse"
              examples:
                default:
                  value:
                    api_key_id: 550e8400-e29b-41d4-a716-446655440000
                    tier: starter
                    usage: 450
                    limit: 1000
                    remaining: 550
                    reset_at: "2025-02-01T00:00:00Z"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"
  /admin/rate-limit/quota/{api_key}/reset:
    post:
      summary: Reset quota for an API key
      description: |
        Resets the quota usage counter for a specific API key to zero (PRD-017 FR-5).
        Optionally accepts a reason for audit purposes.
      security:
        - adminToken: []
      parameters:
        - in: path
          name: api_key
          required: true
          schema:
            type: string
            format: uuid
          description: API key identifier
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResetQuotaRequest"
            examples:
              with_reason:
                value:
                  reason: Customer support escalation
      responses:
        "200":
          description: Quota reset successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: reset
              examples:
                default:
                  value:
                    status: reset
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"
  /admin/rate-limit/quotas:
    get:
      summary: List all API key quotas
      description: |
        Returns quota usage for all registered API keys (PRD-017 FR-5).
      security:
        - adminToken: []
      responses:
        "200":
          description: Quota list retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/QuotaUsageResponse"
              examples:
                default:
                  value:
                    - api_key_id: 550e8400-e29b-41d4-a716-446655440000
                      tier: starter
                      usage: 450
                      limit: 1000
                      remaining: 550
                      reset_at: "2025-02-01T00:00:00Z"
                    - api_key_id: 660e8400-e29b-41d4-a716-446655440001
                      tier: business
                      usage: 5000
                      limit: 10000
                      remaining: 5000
                      reset_at: "2025-02-01T00:00:00Z"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"
  /admin/rate-limit/quota/{api_key}/tier:
    put:
      summary: Update quota tier for an API key
      description: |
        Updates the quota tier for a specific API key (PRD-017 FR-5).
        The new tier's limits take effect immediately.
      security:
        - adminToken: []
      parameters:
        - in: path
          name: api_key
          required: true
          schema:
            type: string
            format: uuid
          description: API key identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateQuotaTierRequest"
            examples:
              upgrade:
                value:
                  tier: business
      responses:
        "200":
          description: Tier updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: updated
                  tier:
                    type: string
                    example: business
              examples:
                default:
                  value:
                    status: updated
                    tier: business
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"
components:
  securitySchemes:
    adminToken:
      type: apiKey
      in: header
      name: X-Admin-Token
      description: Admin API token required for rate limit admin operations
  schemas:
    AllowlistEntryType:
      type: string
      enum:
        - ip
        - user_id
      description: Identifier type for allowlist entries
    EndpointClass:
      type: string
      enum:
        - auth
        - sensitive
        - read
        - write
      description: Endpoint class for rate limiting
    AddAllowlistRequest:
      type: object
      required: [type, identifier, reason]
      properties:
        type:
          $ref: "#/components/schemas/AllowlistEntryType"
        identifier:
          type: string
          description: IP address or user ID
        reason:
          type: string
          description: Reason for allowlisting
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: Optional expiry for the allowlist entry
    RemoveAllowlistRequest:
      type: object
      required: [type, identifier]
      properties:
        type:
          $ref: "#/components/schemas/AllowlistEntryType"
        identifier:
          type: string
          description: IP address or user ID
    ResetRateLimitRequest:
      type: object
      required: [type, identifier]
      properties:
        type:
          $ref: "#/components/schemas/AllowlistEntryType"
        identifier:
          type: string
          description: IP address or user ID
        class:
          $ref: "#/components/schemas/EndpointClass"
    AllowlistEntry:
      type: object
      required: [id, type, identifier, reason, created_at, created_by]
      properties:
        id:
          type: string
          description: Allowlist entry identifier
        type:
          $ref: "#/components/schemas/AllowlistEntryType"
        identifier:
          type: string
          description: IP address or user ID
        reason:
          type: string
        expires_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
          format: uuid
    AllowlistEntryResponse:
      type: object
      required: [allowlisted, identifier]
      properties:
        allowlisted:
          type: boolean
        identifier:
          type: string
        expires_at:
          type: string
          format: date-time
          nullable: true
    RateLimitExceededResponse:
      type: object
      required: [error, message, retry_after]
      properties:
        error:
          type: string
          example: rate_limit_exceeded
        message:
          type: string
        retry_after:
          type: integer
          description: Seconds until retry
    UserRateLimitExceededResponse:
      type: object
      required: [error, message, quota_limit, quota_remaining, quota_reset]
      properties:
        error:
          type: string
          example: user_rate_limit_exceeded
        message:
          type: string
        quota_limit:
          type: integer
        quota_remaining:
          type: integer
        quota_reset:
          type: string
          format: date-time
    ClientRateLimitExceededResponse:
      type: object
      required: [error, message, retry_after]
      properties:
        error:
          type: string
          example: client_rate_limit_exceeded
        message:
          type: string
        retry_after:
          type: integer
          description: Seconds until retry
    ServiceOverloadedResponse:
      type: object
      required: [error, message, retry_after]
      properties:
        error:
          type: string
          example: service_unavailable
        message:
          type: string
        retry_after:
          type: integer
          description: Seconds until retry
    QuotaTier:
      type: string
      enum:
        - free
        - starter
        - business
        - enterprise
      description: API quota tier determining monthly request limits
    QuotaUsageResponse:
      type: object
      required: [api_key_id, tier, usage, limit, remaining, reset_at]
      properties:
        api_key_id:
          type: string
          format: uuid
          description: API key identifier
        tier:
          $ref: "#/components/schemas/QuotaTier"
        usage:
          type: integer
          minimum: 0
          description: Current usage count for this billing period
        limit:
          type: integer
          minimum: 0
          description: Maximum requests allowed per billing period
        remaining:
          type: integer
          minimum: 0
          description: Remaining requests in current billing period
        reset_at:
          type: string
          format: date-time
          description: When the quota resets (start of next billing period)
    ResetQuotaRequest:
      type: object
      properties:
        reason:
          type: string
          description: Optional reason for resetting the quota (for audit)
          maxLength: 500
    UpdateQuotaTierRequest:
      type: object
      required: [tier]
      properties:
        tier:
          $ref: "#/components/schemas/QuotaTier"
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: Machine readable error code
          enum:
            - bad_request
            - unauthorized
            - forbidden
            - not_found
            - conflict
            - internal_error
        error_description:
          type: string
          description: Human readable explanation of the error
  responses:
    BadRequest:
      description: Invalid or malformed request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            invalid_body:
              value:
                error: bad_request
                error_description: "Invalid JSON in request body"
            invalid_identifier:
              value:
                error: bad_request
                error_description: "identifier is required"
    Unauthorized:
      description: Missing or invalid admin token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            missing_token:
              value:
                error: unauthorized
                error_description: "admin token required"
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            not_found:
              value:
                error: not_found
                error_description: "API key not found"
    InternalError:
      description: Unexpected server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            generic:
              value:
                error: internal_error
                error_description: "An unexpected error occurred"
