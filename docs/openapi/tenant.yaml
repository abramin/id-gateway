openapi: 3.0.3
info:
  title: ID Gateway Tenant Management API
  version: 0.1.0
  description: |
    OpenAPI specification for the ID Gateway tenant and client management endpoints.

    Tenants represent isolated identity boundaries. Clients (OAuth relying parties)
    are registered under tenants and can be configured as public or confidential.
servers:
  - url: http://localhost:8080
    description: Local development server
paths:
  /admin/tenants:
    post:
      summary: Create a new tenant
      description: |
        Creates a new tenant in the system. The tenant name must be unique
        and will be trimmed of whitespace. New tenants are created with
        status "active" by default.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTenantRequest"
            examples:
              default:
                summary: Create tenant request
                value:
                  name: Acme Corporation
      responses:
        "201":
          description: Tenant created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateTenantResponse"
              examples:
                default:
                  value:
                    tenant_id: 550e8400-e29b-41d4-a716-446655440000
                    tenant:
                      id: 550e8400-e29b-41d4-a716-446655440000
                      name: Acme Corporation
                      status: active
                      created_at: "2024-01-15T10:30:00Z"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Tenant name already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                duplicate:
                  value:
                    error: conflict
                    error_description: A tenant with this name already exists
        "500":
          $ref: "#/components/responses/InternalError"
  /admin/tenants/{id}:
    get:
      summary: Get tenant details
      description: |
        Returns tenant metadata along with aggregate counts for users and
        clients registered under the tenant. Useful for admin dashboards.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant identifier
      responses:
        "200":
          description: Tenant details retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TenantDetails"
              examples:
                default:
                  value:
                    tenant:
                      id: 550e8400-e29b-41d4-a716-446655440000
                      name: Acme Corporation
                      status: active
                      created_at: "2024-01-15T10:30:00Z"
                    user_count: 150
                    client_count: 3
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"
  /admin/tenants/{id}/deactivate:
    post:
      summary: Deactivate a tenant
      description: |
        Transitions a tenant to inactive status. Deactivated tenants block OAuth
        flows for all clients under them. Existing tokens remain valid until expiry.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant identifier
      responses:
        "200":
          description: Tenant deactivated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tenant"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          description: Tenant is already inactive
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                already_inactive:
                  value:
                    error: conflict
                    error_description: tenant is already inactive
        "500":
          $ref: "#/components/responses/InternalError"
  /admin/tenants/{id}/reactivate:
    post:
      summary: Reactivate a tenant
      description: |
        Transitions a tenant to active status. Reactivated tenants restore OAuth
        flows for their clients.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant identifier
      responses:
        "200":
          description: Tenant reactivated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tenant"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          description: Tenant is already active
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                already_active:
                  value:
                    error: conflict
                    error_description: tenant is already active
        "500":
          $ref: "#/components/responses/InternalError"
  /admin/clients:
    post:
      summary: Register a new OAuth client
      description: |
        Registers a new OAuth client (relying party) under a tenant. The client
        secret is generated server-side and returned only in this response.

        Clients can be either:
        - **Confidential** (default): Can use all grant types including client_credentials
        - **Public** (`public_client: true`): Cannot use client_credentials grant, suitable for SPAs/mobile apps

        The client_id is auto-generated as a URL-safe string.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateClientRequest"
            examples:
              confidential:
                summary: Confidential client
                value:
                  tenant_id: 550e8400-e29b-41d4-a716-446655440000
                  name: Backend Service
                  redirect_uris:
                    - https://api.example.com/callback
                  allowed_grants:
                    - authorization_code
                    - refresh_token
                    - client_credentials
                  allowed_scopes:
                    - openid
                    - profile
                    - email
              public:
                summary: Public client (SPA)
                value:
                  tenant_id: 550e8400-e29b-41d4-a716-446655440000
                  name: Web Application
                  redirect_uris:
                    - https://app.example.com/callback
                  allowed_grants:
                    - authorization_code
                    - refresh_token
                  allowed_scopes:
                    - openid
                    - profile
                  public_client: true
      responses:
        "201":
          description: Client created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClientResponse"
              examples:
                default:
                  value:
                    id: 7c9e6679-7425-40de-944b-e07fc1f90ae7
                    tenant_id: 550e8400-e29b-41d4-a716-446655440000
                    name: Backend Service
                    client_id: clt_abc123xyz
                    client_secret: sec_very-long-random-secret
                    redirect_uris:
                      - https://api.example.com/callback
                    allowed_grants:
                      - authorization_code
                      - refresh_token
                    allowed_scopes:
                      - openid
                      - profile
                    status: active
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Tenant not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalError"
  /admin/clients/{id}:
    get:
      summary: Get client details
      description: |
        Returns client metadata. The client_secret is never returned in GET
        requests for security reasons.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: Client identifier (internal UUID, not the client_id)
      responses:
        "200":
          description: Client details retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClientResponse"
              examples:
                default:
                  value:
                    id: 7c9e6679-7425-40de-944b-e07fc1f90ae7
                    tenant_id: 550e8400-e29b-41d4-a716-446655440000
                    name: Backend Service
                    client_id: clt_abc123xyz
                    redirect_uris:
                      - https://api.example.com/callback
                    allowed_grants:
                      - authorization_code
                      - refresh_token
                    allowed_scopes:
                      - openid
                      - profile
                    status: active
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"
    put:
      summary: Update client configuration
      description: |
        Updates client metadata. All fields are optional - only provided fields
        will be updated. Set `rotate_secret: true` to generate a new client
        secret (the new secret will be returned in the response).
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: Client identifier (internal UUID, not the client_id)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateClientRequest"
            examples:
              update_name:
                summary: Update client name
                value:
                  name: Updated Service Name
              rotate_secret:
                summary: Rotate client secret
                value:
                  rotate_secret: true
              full_update:
                summary: Full update with secret rotation
                value:
                  name: New Service Name
                  redirect_uris:
                    - https://new.example.com/callback
                  allowed_grants:
                    - authorization_code
                    - refresh_token
                  allowed_scopes:
                    - openid
                    - profile
                    - email
                  rotate_secret: true
      responses:
        "200":
          description: Client updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClientResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"
  /admin/clients/{id}/deactivate:
    post:
      summary: Deactivate a client
      description: |
        Transitions a client to inactive status. Deactivated clients block OAuth
        flows. Existing tokens remain valid until expiry.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: Client identifier (internal UUID, not the client_id)
      responses:
        "200":
          description: Client deactivated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClientResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          description: Client is already inactive
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                already_inactive:
                  value:
                    error: conflict
                    error_description: client is already inactive
        "500":
          $ref: "#/components/responses/InternalError"
  /admin/clients/{id}/reactivate:
    post:
      summary: Reactivate a client
      description: |
        Transitions a client to active status. Reactivated clients restore OAuth
        flows.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: Client identifier (internal UUID, not the client_id)
      responses:
        "200":
          description: Client reactivated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClientResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          description: Client is already active
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                already_active:
                  value:
                    error: conflict
                    error_description: client is already active
        "500":
          $ref: "#/components/responses/InternalError"
  /admin/clients/{id}/rotate-secret:
    post:
      summary: Rotate client secret
      description: |
        Generates a new client secret for a confidential client. The previous
        secret is immediately invalidated. The new secret is returned only in
        this response - store it securely as it cannot be retrieved again.

        This operation is not available for public clients.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: Client identifier (internal UUID, not the client_id)
      responses:
        "200":
          description: Client secret rotated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClientResponse"
              examples:
                default:
                  value:
                    id: 7c9e6679-7425-40de-944b-e07fc1f90ae7
                    tenant_id: 550e8400-e29b-41d4-a716-446655440000
                    name: Backend Service
                    client_id: clt_abc123xyz
                    client_secret: sec_new-rotated-secret-value
                    redirect_uris:
                      - https://api.example.com/callback
                    allowed_grants:
                      - authorization_code
                      - refresh_token
                    allowed_scopes:
                      - openid
                      - profile
                    status: active
                    public_client: false
        "400":
          description: Cannot rotate secret for public client
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                public_client:
                  value:
                    error: bad_request
                    error_description: cannot rotate secret for public client
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Admin JWT token required for tenant management operations
  schemas:
    CreateTenantRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          description: Display name for the tenant
          minLength: 1
          maxLength: 128
          example: Acme Corporation
    CreateTenantResponse:
      type: object
      required: [tenant_id, tenant]
      properties:
        tenant_id:
          type: string
          format: uuid
          description: Identifier of the created tenant
        tenant:
          $ref: "#/components/schemas/Tenant"
    Tenant:
      type: object
      required: [id, name, status, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
          description: Unique tenant identifier
        name:
          type: string
          description: Display name for the tenant
          maxLength: 128
        status:
          type: string
          enum: [active, inactive]
          description: Tenant status
        created_at:
          type: string
          format: date-time
          description: Timestamp when the tenant was created
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the tenant was last modified
    TenantDetails:
      type: object
      required: [tenant, user_count, client_count]
      properties:
        tenant:
          $ref: "#/components/schemas/Tenant"
        user_count:
          type: integer
          minimum: 0
          description: Number of users registered under this tenant
        client_count:
          type: integer
          minimum: 0
          description: Number of OAuth clients registered under this tenant
    CreateClientRequest:
      type: object
      required: [tenant_id, name, redirect_uris, allowed_grants, allowed_scopes]
      properties:
        tenant_id:
          type: string
          format: uuid
          description: ID of the tenant this client belongs to
        name:
          type: string
          description: Display name for the client
          minLength: 1
          maxLength: 128
        redirect_uris:
          type: array
          minItems: 1
          items:
            type: string
            format: uri
          description: |
            Allowed redirect URIs for OAuth flows. Must be HTTPS or localhost
            for development.
        allowed_grants:
          type: array
          minItems: 1
          items:
            type: string
            enum: [authorization_code, refresh_token, client_credentials]
          description: |
            OAuth grant types this client is allowed to use.
            Note: client_credentials requires a confidential client.
        allowed_scopes:
          type: array
          minItems: 1
          items:
            type: string
          description: Scopes this client is allowed to request
        public_client:
          type: boolean
          default: false
          description: |
            If true, creates a public client (no client secret, cannot use
            client_credentials grant). Suitable for SPAs and mobile apps.
    UpdateClientRequest:
      type: object
      properties:
        name:
          type: string
          description: Updated display name
          minLength: 1
          maxLength: 128
        redirect_uris:
          type: array
          minItems: 1
          items:
            type: string
            format: uri
          description: Updated redirect URIs
        allowed_grants:
          type: array
          minItems: 1
          items:
            type: string
            enum: [authorization_code, refresh_token, client_credentials]
          description: Updated allowed grant types
        allowed_scopes:
          type: array
          minItems: 1
          items:
            type: string
          description: Updated allowed scopes
        rotate_secret:
          type: boolean
          default: false
          description: |
            If true, generates a new client secret. The new secret will be
            returned in the response. This invalidates the previous secret.
    ClientResponse:
      type: object
      required: [id, tenant_id, name, client_id, redirect_uris, allowed_grants, allowed_scopes, status]
      properties:
        id:
          type: string
          format: uuid
          description: Internal client identifier
        tenant_id:
          type: string
          format: uuid
          description: ID of the tenant this client belongs to
        name:
          type: string
          description: Display name for the client
        client_id:
          type: string
          description: OAuth client_id used in authorization requests
        client_secret:
          type: string
          description: |
            Client secret (only returned on create or when rotate_secret is true).
            Store securely - this value cannot be retrieved again.
        redirect_uris:
          type: array
          items:
            type: string
            format: uri
          description: Allowed redirect URIs
        allowed_grants:
          type: array
          items:
            type: string
          description: Allowed OAuth grant types
        allowed_scopes:
          type: array
          items:
            type: string
          description: Allowed scopes
        status:
          type: string
          enum: [active, inactive]
          description: Client status
        public_client:
          type: boolean
          description: |
            True if this is a public client (no secret, cannot use client_credentials).
            False for confidential clients.
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: Machine readable error code
          enum:
            [
              bad_request,
              unauthorized,
              forbidden,
              not_found,
              conflict,
              internal_error,
            ]
        error_description:
          type: string
          description: Human readable explanation of the error
  responses:
    BadRequest:
      description: Invalid or malformed request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            validation_failure:
              value:
                error: bad_request
                error_description: Invalid JSON in request body
    Unauthorized:
      description: Missing or invalid credentials
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            missing_header:
              value:
                error: unauthorized
                error_description: Missing or invalid Authorization header
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            not_found:
              value:
                error: not_found
                error_description: Resource not found
    InternalError:
      description: Unexpected server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            generic:
              value:
                error: internal_error
