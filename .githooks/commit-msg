#!/usr/bin/env bash
set -euo pipefail

msg_file="${1:-}"
if [[ -z "$msg_file" || ! -f "$msg_file" ]]; then
  echo "commit-msg hook: missing commit message file."
  exit 1
fi

# Get first non-comment line (commit subjects are on line 1, but be defensive)
subject="$(grep -vE '^\s*#' "$msg_file" | head -n 1 | tr -d '\r')"

# Allow empty (rare) or system-generated commits
if [[ -z "$subject" ]]; then
  exit 0
fi

# Allow merges/reverts without enforcement
if [[ "$subject" =~ ^Merge\  ]] || [[ "$subject" =~ ^Revert\  ]]; then
  exit 0
fi

# Allowed types (extend if you want)
types_regex='feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert'

# Enforce Conventional Commits header:
# type(scope optional): space summary
header_regex="^(${types_regex})(\\([a-zA-Z0-9._/-]+\\))?:\\ [^ ].+"

if ! [[ "$subject" =~ $header_regex ]]; then
  echo "❌ Invalid commit subject."
  echo "Expected: type(scope): summary"
  echo "Examples:"
  echo "  feat(auth): rotate refresh tokens [PRD-026A]"
  echo "  refactor(pkg/http): simplify middleware chain"
  echo "Allowed types: ${types_regex}"
  exit 1
fi

# If feat/fix, require PRD tag in subject
# Accepts: [PRD-26], [PRD-026], [PRD-26A], [PRD-026A], [PRD-1B], etc.
prd_regex='(\[PRD-[0-9]{1,4}[A-Z]?\])'

if [[ "$subject" =~ ^(feat|fix) ]] && ! [[ "$subject" =~ $prd_regex ]]; then
  echo "❌ feat/fix commits must include a PRD tag in the subject."
  echo "Add one like: [PRD-26], [PRD-026], [PRD-26A], [PRD-026A]"
  echo "Example:"
  echo "  feat(auth): add device-bound refresh tokens [PRD-026A]"
  exit 1
fi

exit 0
